<div class="bg-white rounded-lg shadow-md w-full">
  <div class="flex items-center justify-between p-6 border-b border-gray-200">
    <h2 class="text-xl font-semibold text-gray-900">
      {{ action() === 'pull' ? config.title : 'Push to ' + config.serviceName }}
    </h2>
    <button
      (click)="onClose()"
      class="text-gray-400 hover:text-gray-600 transition-colors"
      aria-label="Close modal"
    >
      <ng-icon name="heroXMark" class="size-6"></ng-icon>
    </button>
  </div>

  <div class="p-6 space-y-6">
    <!-- Status Section -->
    <div class="flex items-start space-x-2">
      <div class="flex-shrink-0">
        <ng-icon
          [name]="statusIcon()"
          [ngClass]="statusColor()"
          class="text-2xl mt-1"
          [class.animate-spin]="isLoading()"
        ></ng-icon>
      </div>
      <div>
        <h3 class="text-lg font-medium text-gray-900">Connection Status</h3>
        <p [ngClass]="statusColor()" class="text-sm font-medium">
          {{ statusText() }}
        </p>
      </div>
    </div>

    <!-- Error Message -->
    <div
      *ngIf="!isLoading() && connectionStatus().errorMessage"
      class="bg-red-50 border border-red-200 rounded-lg p-4"
    >
      <div class="flex items-center space-x-2">
        <ng-icon
          name="heroExclamationTriangle"
          class="size-5 text-red-500"
        ></ng-icon>
        <h4 class="text-sm font-medium text-red-800">Error</h4>
      </div>
      <p class="text-sm text-red-700 mt-1">
        {{ connectionStatus().errorMessage }}
      </p>
    </div>

    <!-- Work Items Section -->
    <div
      *ngIf="connectionStatus().isConnected"
      class="bg-white border border-gray-200 rounded-lg overflow-hidden mt-4"
    >
      <div class="border-b border-gray-200 p-4 bg-gray-50">
        <div class="flex items-center justify-between">
          <div>
            <h4 class="font-medium text-gray-900">
              {{ action() === 'pull' ? 'Work Items from ' + config.serviceName : 'Items to Push to ' + config.serviceName }}
            </h4>
            <p class="text-xs text-gray-600 mt-1">
              {{ action() === 'pull' ? 
                config.itemLabels.topLevel + 's and their child items' : 
                'Select items to push to ' + config.serviceName }}
            </p>
          </div>
          <div class="flex items-center">
            <input
              type="checkbox"
              id="selectAllItems"
              [checked]="allItemsSelected()"
              (click)="toggleSelectAllItems($event)"
              class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"
            />
            <label
              for="selectAllItems"
              class="ml-2 text-sm text-gray-700 cursor-pointer"
              >Select All</label
            >
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div
        *ngIf="isLoadingWorkItems()"
        class="flex items-center justify-center p-8"
      >
        <ng-icon
          name="heroArrowPath"
          class="animate-spin text-blue-600 size-6"
        ></ng-icon>
        <span class="ml-3 text-gray-600">Loading work items...</span>
      </div>

      <!-- No Items State -->
      <div
        *ngIf="!isLoadingWorkItems() && prdsWithChildren().length === 0"
        class="p-8 text-center"
      >
        <p class="text-gray-600">
          No work items found in this {{ config.serviceName }} project
        </p>
      </div>

      <!-- Work Items List -->
      <div
        *ngIf="!isLoadingWorkItems() && prdsWithChildren().length > 0"
        class="divide-y divide-gray-100 max-h-96 overflow-y-auto"
      >
        <div *ngFor="let prd of prdsWithChildren()" class="py-2 px-4">
          <!-- PRD (Top-level) Item -->
          <div
            (click)="togglePrdExpansion(prd.specifaiId)"
            class="flex items-center py-2 cursor-pointer hover:bg-gray-50"
          >
            <!-- Checkbox -->
            <input
              type="checkbox"
              [id]="'prd-' + prd.specifaiId"
              [checked]="isPrdSelected(prd.specifaiId)"
              (click)="togglePrdSelection($event, prd.specifaiId)"
              class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 mr-2"
            />

            <ng-icon
              [name]="
                isPrdExpanded(prd.specifaiId)
                  ? 'heroChevronDown'
                  : 'heroChevronRight'
              "
              class="size-4 text-gray-500 mr-2"
            >
            </ng-icon>
            <div class="flex-grow">
              <div class="flex items-center">
                <span class="text-sm font-medium text-gray-900">{{
                  prd.title
                }}</span>
                <span
                  class="ml-2 px-2 py-0.5 text-xs font-medium rounded-full"
                  [ngClass]="getTopLevelBadgeColor()"
                >
                  {{ config.itemLabels.topLevel }} #{{ prd.specifaiId }}
                </span>
              </div>
              <p class="text-xs text-gray-600 mt-1">
                {{ prd.pmoIssueType }}
              </p>
            </div>
          </div>

          <!-- Mid-level Items (Platform Features / Stories) -->
          <div
            *ngIf="isPrdExpanded(prd.specifaiId)"
            class="ml-6 pl-4 border-l border-gray-200"
          >
            <!-- No Mid-level Items State -->
            <div
              *ngIf="!prd.child || prd.child.length === 0"
              class="py-2 text-center"
            >
              <span class="text-xs text-gray-500"
                >No {{ config.itemLabels.midLevel }}s</span
              >
            </div>

            <!-- Mid-level Items -->
            <div *ngFor="let platformFeature of prd.child" class="py-2">
              <!-- Mid-level Item -->
              <div
                (click)="toggleUserStoryExpansion(platformFeature.specifaiId)"
                class="flex items-center py-2 cursor-pointer hover:bg-gray-50"
              >
                <!-- Checkbox -->
                <input
                  type="checkbox"
                  [id]="'platform-feature-' + platformFeature.specifaiId"
                  [checked]="isUserStorySelected(platformFeature.specifaiId)"
                  (click)="toggleUserStorySelection($event, platformFeature.specifaiId)"
                  class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 mr-2"
                />

                <ng-icon
                  [name]="
                    isUserStoryExpanded(platformFeature.specifaiId)
                      ? 'heroChevronDown'
                      : 'heroChevronRight'
                  "
                  class="size-4 text-gray-500 mr-2"
                >
                </ng-icon>
                <div class="flex-grow">
                  <div class="flex items-center">
                    <span class="text-sm font-medium text-gray-800">{{
                      platformFeature.title
                    }}</span>
                    <span
                      class="ml-2 px-2 py-0.5 text-xs font-medium rounded-full"
                      [ngClass]="getMidLevelBadgeColor()"
                    >
                      {{ config.itemLabels.midLevel }} #{{
                        platformFeature.specifaiId
                      }}
                    </span>
                  </div>
                  <p class="text-xs text-gray-600 mt-1">
                    {{ platformFeature.pmoIssueType }}
                  </p>
                </div>
              </div>

              <!-- Bottom-level Items (User Stories / Sub-tasks) -->
              <div
                *ngIf="isUserStoryExpanded(platformFeature.specifaiId)"
                class="ml-6 pl-4 border-l border-gray-200"
              >
                <!-- No Bottom-level Items State -->
                <div
                  *ngIf="
                    !platformFeature.child || platformFeature.child.length === 0
                  "
                  class="py-2 text-center"
                >
                  <span class="text-xs text-gray-500"
                    >No {{ config.itemLabels.bottomLevel }}s</span
                  >
                </div>

                <!-- Bottom-level Items -->
                <div
                  *ngFor="let userStory of platformFeature.child"
                  class="py-2"
                >
                  <div class="flex items-center">
                    <!-- Checkbox -->
                    <input
                      type="checkbox"
                      [id]="'user-story-' + userStory.specifaiId"
                      [checked]="isTaskSelected(userStory.specifaiId)"
                      (click)="toggleTaskSelection($event, userStory.specifaiId)"
                      class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 mr-2"
                    />

                    <div class="flex-grow">
                      <div class="flex items-center">
                        <span class="text-sm font-medium text-gray-800">{{
                          userStory.title
                        }}</span>
                        <span
                          class="ml-2 px-2 py-0.5 text-xs font-medium rounded-full"
                          [ngClass]="getBottomLevelBadgeColor()"
                        >
                          {{ config.itemLabels.bottomLevel }} #{{
                            userStory.specifaiId
                          }}
                        </span>
                      </div>
                      <p class="text-xs text-gray-600 mt-1">
                        {{ userStory.pmoIssueType }}
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div
    class="flex justify-end space-x-3 p-6 border-t border-gray-200 bg-gray-50 rounded-b-lg"
  >
    <app-button
      buttonContent="Cancel"
      theme="secondary"
      size="sm"
      (click)="onClose()"
    >
    </app-button>

    <app-button
      *ngIf="!connectionStatus().isConnected"
      buttonContent="Configure Integration"
      theme="primary"
      size="sm"
      (click)="onConfigureIntegration()"
    >
    </app-button>

    <app-button
      *ngIf="connectionStatus().isConnected"
      [buttonContent]="action() === 'pull' ? 'Pull Items' : 'Push Items'"
      theme="primary"
      size="sm"
      (click)="onProceed()"
    >
    </app-button>
  </div>
</div>
