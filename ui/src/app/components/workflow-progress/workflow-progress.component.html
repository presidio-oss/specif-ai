<div *ngIf="isVisible" class="p-4 max-w-4xl mx-auto">
  <div *ngIf="showHeader" class="flex items-center justify-between mb-4">
    <h1 class="font-semibold text-gray-900 truncate">
      {{ isCompleted ? completedTitle : title }}
    </h1>
    <div class="flex items-center gap-3">
      <button
        *ngIf="showCancelButton && (workflowStatus$ | async)?.isCreating"
        (click)="onCancelClick()"
        [disabled]="isAborting"
        class="flex items-center gap-2 px-3 py-1.5 text-xs font-medium text-red-700 bg-red-50 border border-red-200 rounded-full hover:bg-red-100 hover:border-red-300 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
        type="button"
      >
        <div
          *ngIf="isAborting"
          class="w-3 h-3 border-2 border-red-600 border-t-transparent rounded-full animate-spin"
        ></div>
        <ng-icon *ngIf="!isAborting" name="heroXMark" class="w-3 h-3"></ng-icon>
        <span>{{ isAborting ? "Cancelling..." : "Cancel" }}</span>
      </button>

      <div
        class="flex items-center text-xs font-medium bg-gray-50 rounded-full px-3 py-1.5 border border-gray-200 shadow-sm"
      >
        <div
          class="w-1.5 h-1.5 bg-primary-600 rounded-full mr-2 animate-pulse"
        ></div>
        <span class="whitespace-nowrap">
          {{ isCompleted ? completedSubtitle : subtitle }}
        </span>
      </div>
    </div>
  </div>

  <div
    class="space-y-1 overflow-y-auto"
    [style.max-height]="maxHeight"
    *ngIf="progress$ | async as progress"
  >
    <div *ngFor="let step of progress; let i = index" class="group">
      <div
        *ngIf="!hasInputOutput(step)"
        class="flex items-center space-x-3 py-2 px-3 rounded-md transition-all duration-200 border border-secondary-200"
      >
        <div class="flex-shrink-0 relative">
          <div
            class="absolute inset-0 rounded-full blur-md opacity-30"
            [ngClass]="{
              'bg-primary-400': step.type === 'thinking',
              'bg-success-400': step.type === 'action',
              'bg-amber-400': step.type === 'mcp',
            }"
          ></div>
          <ng-icon
            [name]="
              step.type === 'thinking'
                ? 'heroSparkles'
                : step.type === 'action'
                  ? 'heroCheckCircle'
                  : 'heroWrenchScrewdriver'
            "
            class="h-5 w-5 mt-0.5 shrink-0 relative"
            [class.text-primary-500]="step.type === 'thinking'"
            [class.text-success-500]="step.type === 'action'"
            [class.text-amber-500]="step.type === 'mcp'"
          ></ng-icon>
        </div>

        <div class="flex-1 min-w-0 flex items-center justify-between">
          <div class="flex items-center space-x-2">
            <span
              class="text-sm leading-relaxed flex-1"
              [ngClass]="{
                'text-primary-700': step.type === 'thinking',
                'text-success-700': step.type === 'action',
                'text-amber-700': step.type === 'mcp',
              }"
              >{{ step.message.title }}</span
            >
          </div>

          <div class="flex items-center space-x-2">
            <div
              *ngIf="shouldShowSpinner(step, progress)"
              class="inline-block w-3 h-3 border-2 border-t-transparent rounded-full animate-spin"
              [ngClass]="{
                'border-primary-500': step.type === 'thinking',
                'border-success-500': step.type === 'action',
                'border-amber-500': step.type === 'mcp',
              }"
              role="status"
              aria-label="Executing"
            ></div>
          </div>
        </div>
      </div>

      <app-custom-accordion
        *ngIf="hasInputOutput(step)"
        [id]="getAccordionId(step, i)"
        [isOpen]="false"
        triggerClassName="py-2 px-3 rounded-md cursor-pointer transition-all duration-200"
        bodyClassName="px-3 pb-3 mt-2"
      >
        <div accordion-trigger class="flex items-center space-x-3">
          <div class="flex-shrink-0 relative">
            <div
              class="absolute inset-0 rounded-full blur-md opacity-30"
              [ngClass]="{
                'bg-primary-400': step.type === 'thinking',
                'bg-success-400': step.type === 'action',
                'bg-amber-400': step.type === 'mcp',
              }"
            ></div>
            <ng-icon
              [name]="
                step.type === 'thinking'
                  ? 'heroSparkles'
                  : step.type === 'action'
                    ? 'heroCheckCircle'
                    : 'heroWrenchScrewdriver'
              "
              class="h-5 w-5 mt-0.5 shrink-0 relative"
              [class.text-primary-500]="step.type === 'thinking'"
              [class.text-success-500]="step.type === 'action'"
              [class.text-amber-500]="step.type === 'mcp'"
            ></ng-icon>
          </div>

          <div class="flex-1 min-w-0 flex items-center justify-between">
            <div class="flex items-center space-x-2">
              <p
                class="text-sm leading-relaxed flex-1"
                [ngClass]="{
                  'text-primary-700': step.type === 'thinking',
                  'text-success-700': step.type === 'action',
                  'text-amber-700': step.type === 'mcp',
                }"
              >
                {{ step.message.title }}
              </p>
            </div>
          </div>
        </div>

        <div
          accordion-body
          class="space-y-3 mt-3 border-t border-gray-100 pt-3"
        >
          <div *ngIf="step.message.input" class="space-y-2">
            <div class="flex items-center space-x-2">
              <h4
                class="text-xs font-semibold text-gray-600 uppercase tracking-wide"
              >
                Input
              </h4>
              <div class="flex-1 h-px bg-gray-200"></div>
            </div>
            <div
              class="bg-gray-50 border border-gray-200 rounded-lg p-3 max-h-40 overflow-y-auto"
            >
              <pre
                class="text-xs text-gray-700 whitespace-pre-wrap font-mono leading-relaxed"
                >{{ formatData(step.message.input) }}</pre
              >
            </div>
          </div>

          <div *ngIf="step.message.output" class="space-y-2">
            <div class="flex items-center space-x-2">
              <h4
                class="text-xs font-semibold text-gray-600 uppercase tracking-wide"
              >
                Output
              </h4>
              <div class="flex-1 h-px bg-gray-200"></div>
            </div>
            <div
              class="bg-gray-50 border border-gray-200 rounded-lg p-3 max-h-40 overflow-y-auto"
            >
              <pre
                class="text-xs text-gray-700 whitespace-pre-wrap font-mono leading-relaxed"
                >{{ formatData(step.message.output) }}</pre
              >
            </div>
          </div>
        </div>
      </app-custom-accordion>
    </div>
  </div>
</div>
